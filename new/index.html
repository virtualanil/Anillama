<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typing Defender - Mobile Friendly</title>
<meta name="description" content="Play Typing Defender, a free 3D typing shooter game on mobile or desktop. Improve your WPM and accuracy while defending the system from cyber enemies.">
<meta name="author" content="Anil Lama">

<!-- Firebase SDKs (Modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, serverTimestamp, getDocs, query, orderBy, limit, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCNVdBXRTJMkACc46EUmn38Vy4Flz3vDOQ",
    authDomain: "typing-game-c5e84.firebaseapp.com",
    projectId: "typing-game-c5e84",
    storageBucket: "typing-game-c5e84.firebasestorage.app",
    messagingSenderId: "1017813191155",
    appId: "1:1017813191155:web:af354c72711c6488562a86"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
window.currentUser = null;

onAuthStateChanged(auth, (user) => {
    const loginBtn = document.getElementById("loginBtn");
    const startBtn = document.getElementById("startBtn");
    const userDisplay = document.getElementById("userDisplay");

    if (user) {
        window.currentUser = user;
        if(userDisplay) userDisplay.innerHTML = `COMMANDER: <span>${user.displayName}</span>`;
        if(loginBtn) loginBtn.classList.add('hidden');
        if(startBtn) startBtn.classList.remove('hidden');
        console.log("User logged in:", window.currentUser.displayName);
    } else {
        window.currentUser = null;
        if(userDisplay) userDisplay.innerHTML = `GUEST`;
        if(loginBtn) loginBtn.classList.remove('hidden');
        if(startBtn) startBtn.classList.add('hidden');
    }
});

window.loginWithGoogle = async function () {
    try {
        const result = await signInWithPopup(auth, provider);
        window.currentUser = result.user;
    } catch (err) {
        console.error(err);
        alert("Login failed: " + err.message);
    }
};

window.saveScore = async function(score, wpm) {
    if (!window.currentUser) return;
    try {
        const userDocRef = doc(db, "leaderboard", window.currentUser.uid);
        const docSnap = await getDoc(userDocRef);
        let shouldSave = false;

        if (docSnap.exists()) {
            const existingData = docSnap.data();
            if (score > existingData.score) shouldSave = true;
        } else shouldSave = true;

        if (shouldSave) {
            await setDoc(userDocRef, {
                name: window.currentUser.displayName,
                email: window.currentUser.email,
                score: score,
                wpm: wpm,
                time: serverTimestamp()
            });
        }
    } catch(e) { console.error(e); }
};

window.loadLeaderboard = async function() {
    const listEl = document.getElementById('leaderboard-list');
    listEl.innerHTML = '<li>Loading...</li>';
    try {
        const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(5));
        const querySnapshot = await getDocs(q);
        listEl.innerHTML = '';
        if (querySnapshot.empty) {
            listEl.innerHTML = '<li>No scores yet. Be the first!</li>';
            return;
        }
        querySnapshot.forEach((docSnapshot) => {
            const data = docSnapshot.data();
            const li = document.createElement('li');
            li.innerHTML = `
                <span class="lb-name">${data.name}</span>
                <span class="lb-stats">WPM: ${data.wpm}</span>
                <span class="lb-score">${data.score}</span>
            `;
            listEl.appendChild(li);
        });
    } catch (error) {
        console.error(error);
        listEl.innerHTML = '<li>Error loading scores.</li>';
    }
};
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap');

:root {
    --primary: #00f3ff;
    --danger: #ff0055;
    --success: #00ff66;
    --bg: #050510;
    --ui-font: 'Orbitron', sans-serif;
    --type-font: 'Roboto Mono', monospace;
}

body {
    margin: 0;
    overflow: hidden;
    background-color: var(--bg);
    color: white;
    font-family: var(--ui-font);
    user-select: none;
    touch-action: manipulation;
}

#game-container { position: relative; width: 100vw; height: 100vh; }
canvas { display: block; width: 100%; height: 100%; }

.ui-layer { position: absolute; pointer-events: none; width: 100%; height: 100%; top: 0; left: 0; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }

.hud-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; font-size: 1.2rem; text-shadow: 0 0 10px var(--primary); gap: 10px; }
.hud-stat { background: rgba(0, 0, 0, 0.6); padding: 10px 20px; border: 1px solid var(--primary); border-radius: 4px; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); }
.hud-stat span { color: var(--primary); font-weight: bold; }

.hud-combo { text-align: center; color: var(--success); font-size: 1.5rem; text-shadow: 0 0 20px var(--success); opacity: 0; transition: opacity 0.2s, transform 0.1s; }

.current-input { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); font-family: var(--type-font); font-size: 2rem; color: var(--primary); text-shadow: 0 0 10px var(--primary); letter-spacing: 5px; opacity: 0.8; pointer-events: none; transition: transform 0.1s; }
.current-input span { color: #fff; background: var(--danger); padding: 0 5px; border-radius: 4px; }

.modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 16, 0.85); backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; pointer-events: auto; transition: opacity 0.3s; overflow-y: auto; }
.hidden { display: none !important; opacity: 0; pointer-events: none; }

h1 { font-size: 4rem; margin: 0; background: linear-gradient(to bottom, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; letter-spacing: 5px; filter: drop-shadow(0 0 15px var(--primary)); text-align: center; }
h2 { font-size: 1.5rem; color: #fff; margin-bottom: 20px; text-shadow: 0 0 5px var(--primary); font-weight: 400; text-align: center; }

p.subtitle { font-family: var(--type-font); color: #aaa; font-size: 1.2rem; margin-bottom: 40px; text-align: center; max-width: 600px; line-height: 1.6; }

.btn { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 15px 40px; font-size: 1.5rem; font-family: var(--ui-font); text-transform: uppercase; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; pointer-events: auto; margin: 10px; }
.btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
.btn:disabled { border-color: #555; color: #555; cursor: not-allowed; box-shadow: none; }

.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; text-align: left; min-width: 300px; }
.stat-box { border-left: 4px solid var(--danger); padding-left: 15px; }
.stat-label { font-size: 0.8rem; color: #888; }
.stat-value { font-size: 1.5rem; font-weight: bold; }

.leaderboard-container { margin-top: 20px; width: 100%; max-width: 500px; background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 20px; border-radius: 8px; }
.leaderboard-container h3 { margin: 0 0 15px 0; color: var(--success); text-align: center; text-transform: uppercase; font-size: 1.2rem; }
ul#leaderboard-list { list-style: none; padding: 0; margin: 0; }
ul#leaderboard-list li { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; font-family: var(--type-font); font-size: 0.9rem; }
ul#leaderboard-list li:last-child { border-bottom: none; }
.lb-name { color: #fff; flex: 1; }
.lb-stats { color: #aaa; margin-right: 15px; }
.lb-score { color: var(--primary); font-weight: bold; }

@media (max-width: 600px) {
    h1 { font-size: 2.5rem; }
    .stats-grid { grid-template-columns: 1fr; }
    .hud-top { font-size: 0.9rem; }
    .hud-stat { padding: 5px 10px; }
}

/* Mobile input field hidden on desktop */
#mobileInput { 
    position: absolute; 
    bottom: 10px; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 80%; 
    font-size: 2rem; 
    text-align: center; 
    background: rgba(0,0,0,0.7); 
    border: 2px solid var(--primary); 
    color: #fff; 
    outline: none; 
    border-radius: 8px; 
    display: none;
}
</style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <input type="text" id="mobileInput" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" />

    <div class="current-input" id="inputBufferDisplay"></div>

    <div class="ui-layer" id="hud">
        <div class="hud-top">
            <div class="hud-stat" id="userDisplay">GUEST</div>
            <div class="hud-stat">SCORE: <span id="scoreDisplay">0</span></div>
            <div class="hud-stat">WPM: <span id="wpmDisplay">0</span></div>
        </div>
        <div class="hud-combo" id="comboDisplay">COMBO x1</div>
    </div>

    <div class="modal" id="startScreen">
        <h1>TYPING GAME</h1>
        <h2>BY ANIL LAMA</h2>
        <p class="subtitle">Typing Game words to destroy enemies.<br>
        <strong>SMART TARGETING:</strong> Type until words differ to lock the correct one.<br>
        Typing wrong resets combo.<br>
        <strong>FEATURE:</strong> Press SPACE to spawn extra enemies instantly.<br>
        Press ESC to Pause.</p>
        <button id="startBtn" class="btn hidden" onclick="game.start()">START GAME</button>
        <button id="loginBtn" class="btn" onclick="loginWithGoogle()">Login with Gmail</button>
    </div>

    <div class="modal hidden" id="pauseScreen">
        <h1>GAME PAUSED</h1>
        <h2>Game Rokyo!!</h2>
        <button class="btn" onclick="game.togglePause()">RESUME</button>
    </div>

    <div class="modal hidden" id="gameOverScreen">
        <h1 style="color: var(--danger); -webkit-text-fill-color: var(--danger);">GAME OVER</h1>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">FINAL SCORE</div>
                <div class="stat-value" id="finalScore">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">MAX WPM</div>
                <div class="stat-value" id="finalWpm">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ACCURACY</div>
                <div class="stat-value" id="finalAcc">0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">WORDS DESTROYED</div>
                <div class="stat-value" id="finalWords">0</div>
            </div>
        </div>

        <div class="leaderboard-container">
            <h3>Top 5 Defenders</h3>
            <ul id="leaderboard-list"><li>Loading...</li></ul>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn" onclick="game.restart()">TRY AGAIN</button>
        </div>
    </div>
</div>

<script>
// The Game class and all the logic remains the same as your desktop version
// Only difference is connecting the mobile input
const mobileInput = document.getElementById('mobileInput');

mobileInput.addEventListener('input', (e) => {
    const val = e.target.value.toLowerCase();
    if(val.length > 0){
        const lastChar = val[val.length-1];
        const event = { key: lastChar };
        game.handleInput(event);
    }
    e.target.value = '';
});

// Detect mobile and show input
if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
    mobileInput.style.display = 'block';
    setTimeout(() => mobileInput.focus(), 500);
}

// Initialize the game
const game = new Game();

</script>
</body>
</html>
